name: Frontend Chat CI/CD

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production
    steps:
    - name: Deploy using ssh
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY_FOR_VPS }}
        port: 22
        script: |
          cd /var/www/chat_online/fe_chat
          git checkout main
          git fetch origin
          git pull origin main
          echo "üìù Creating .env file..."

          # X√≥a file .env c≈© n·∫øu t·ªìn t·∫°i ƒë·ªÉ tr√°nh l·ªói
          rm -f .env 
          
          # S·ª≠ d·ª•ng echo v√† redirect v√†o file .env
          # L∆∞u √Ω: C√°c secrets s·∫Ω ƒë∆∞·ª£c truy·ªÅn t·ª´ GitHub Secrets v√†o script n√†y
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> .env
          echo "NEXT_PUBLIC_SOCKET_URL=${{ secrets.NEXT_PUBLIC_SOCKET_URL }}" >> .env
          
          echo "‚úÖ .env file created successfully."
          
          # Stop v√† remove container c≈© n·∫øu t·ªìn t·∫°i
          docker stop chat-frontend-container || true
          docker rm chat-frontend-container || true
          
          # X√≥a image c≈© ƒë·ªÉ tr√°nh t√≠ch t·ª• v√† ti·∫øt ki·ªám dung l∆∞·ª£ng
          docker rmi chat-frontend || true
          
          # Build image m·ªõi
          docker build -t chat-frontend .
          
          # Run container m·ªõi
          docker run -d -p 4000:3000 --name chat-frontend-container chat-frontend
